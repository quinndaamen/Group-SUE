@using SUE.Services.Sensors.Models
@model GraphsViewModel
@{
    ViewData["Title"] = "Air Quality Graph";
}

<style>
    body { 
        background-color: #f8f9fa; 
    }
    
    .dashboard { 
        padding: 20px; min-height: 100vh; 
    }
    
    .dashboard h1 { 
        font-size: 24px;
        font-weight: bold;
        color: #0A0A0A;
        margin-bottom: 5px; 
    }
    
    .subtitle { 
        color: #717182; 
        font-size: 16px; 
        margin-bottom: 20px; 
    }
    
    .card { 
        background: white; 
        border-radius: 12px; 
        padding: 20px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px; 
    }
    
    .metric-label { 
        color: #717182; 
        font-size: 14px; 
        margin-bottom: 5px; 
    }
    
    .metric-value { 
        font-size: 24px; 
        font-weight: bold; 
        color: #0A0A0A; 
        margin: 5px 0; 
    }
    
    .metric-value-large { 
        font-size: 36px; 
        font-weight: bold; 
        margin: 15px 0; 
    }
    
    .graph-container { 
        position: relative; 
        height: 350px; 
        width: 100%; 
        margin: 20px 0; 
    }
    
    .graph-axes { 
        position: absolute; 
        top: 0; 
        left: 50px; 
        right: 20px; 
        bottom: 50px; 
        border-left: 1px solid #e5e7eb; 
        border-bottom: 1px solid #e5e7eb; 
    }
    
    .y-axis { 
        position: absolute; 
        left: -50px; 
        top: 0; 
        bottom: 0; 
        width: 40px; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-between; 
    }
    
    .y-label {
        color: #717182; 
        font-size: 12px; 
        text-align: right; 
        padding-right: 10px; 
    }
    
    .x-axis { 
        position: absolute; 
        left: 0; 
        right: 0; 
        bottom: -40px; 
        height: 40px; 
        display: flex; 
        justify-content: space-between; 
    }
    
    .x-label { 
        color: #717182; 
        font-size: 12px; 
        text-align: center; 
        width: 40px; 
        transform: rotate(-45deg); 
        transform-origin: top left; 
    }
    
    .graph-line { 
        position: absolute; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        height: 100%; 
        display: flex; 
        align-items: flex-end; 
    }
    
    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 20px; 
        margin-top: 30px; 
    }
    
    .stat-card { 
        background: white; 
        border-radius: 12px; 
        padding: 24px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        height: 100%; 
    }
    
    .stat-card-highlight { 
        background: linear-gradient(148deg, rgba(219, 234, 254, 1) 0%, rgba(239, 246, 255, 1) 100%); 
    }
    
    .stat-title { 
        color: #717182; font-size: 14px; margin-bottom: 8px; 
    }
    
    .stat-number { 
        font-size: 32px; 
        font-weight: bold; 
        color: #0A0A0A; 
        margin-bottom: 8px; 
    }
    
    .stat-status { 
        color: #00C950; 
        font-weight: 500; 
        font-size: 16px; 
    }
    
    .stat-unit { 
        font-size: 16px; 
        color: #717182; 
        margin-left: 4px; 
    }
    
    .page-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 30px; 
    }
</style>

@{
    // Safe calculations with explicit type
    var avgAqi = Model.AqiLast4Hours.Any() 
        ? Math.Round((decimal)Model.AqiLast4Hours.Average((HourlyValueDto a) => a.Value)) 
        : 0;
    var minAqi = Model.AqiLast4Hours.Any() 
        ? Model.AqiLast4Hours.Min((HourlyValueDto a) => a.Value) 
        : 0;
    var maxAqi = Model.AqiLast4Hours.Any() 
        ? Model.AqiLast4Hours.Max((HourlyValueDto a) => a.Value) 
        : 0;
}

<div class="dashboard">
    <div class="page-header">
        <div>
            <h1>S.U.E - Air Quality</h1>
            <p class="subtitle">Eindhoven, North Brabant - Air quality index over the last 4 hours</p>
        </div>
    </div>

    <div class="card">
        <h2>4-Hour Air Quality</h2>
        <p class="metric-label">Hourly AQI measurements</p>
        <div class="graph-container">
            <div class="graph-axes">
                <div class="y-axis">
                    <div class="y-label">300 AQI</div>
                    <div class="y-label">200 AQI</div>
                    <div class="y-label">150 AQI</div>
                    <div class="y-label">100 AQI</div>
                    <div class="y-label">50 AQI</div>
                    <div class="y-label">0 AQI</div>
                </div>
                <div class="x-axis">
                    @foreach (var item in Model.AqiLast4Hours)
                    {
                        <div class="x-label">@item.Hour:00</div>
                    }
                </div>


                <div class="graph-line" id="airQualityGraph"></div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card stat-card-highlight">
            <div class="stat-title">Current AQI</div>
            <div class="stat-number">@(Model.AqiLast4Hours.LastOrDefault()?.Value ?? 0) <span class="stat-unit">AQI</span></div>
            <div class="stat-status">
                Good
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-title">24h Average</div>
            <div class="stat-number">@avgAqi <span class="stat-unit">AQI</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Range (Low - High)</div>
            <div class="stat-number">@minAqi - @maxAqi <span class="stat-unit">AQI</span></div>
        </div>
    </div>
</div>

<script>
    const airQualityData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.AqiLast4Hours,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }
    ));

    const graphElement = document.getElementById('airQualityGraph');

    airQualityData.forEach((item, index) => {
        const pointContainer = document.createElement('div');
        pointContainer.className = 'data-point';

        const point = document.createElement('div');
        point.className = 'point-value';

        const MAX_AQI = 300;
        const heightPercent = Math.min((value / MAX_AQI) * 100, 100);

        point.style.height = `${heightPercent}%`;
        point.style.setProperty('--point-height', `${heightPercent}%`);

        if (item.value <= 50) point.style.backgroundColor = '#00C950';
        else if (item.value <= 100) point.style.backgroundColor = '#FFD700';
        else point.style.backgroundColor = '#FF8C00';

        point.title = `${item.hour.toString().padStart(2,'0')}:00 - ${item.value} AQI`;
        pointContainer.appendChild(point);

        if (index % 3 === 0) {
            const label = document.createElement('div');
            label.className = 'point-label';
            label.textContent = `${item.hour.toString().padStart(2,'0')}:00`;
            pointContainer.appendChild(label);
        }

        graphElement.appendChild(pointContainer);
    });
</script>