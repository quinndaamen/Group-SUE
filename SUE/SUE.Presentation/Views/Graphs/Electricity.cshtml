@using SUE.Services.Sensors.Models
@model GraphsViewModel
@{
    ViewData["Title"] = "Electricity Graph";
}

<style>
    /* Styles copied from your Electricity view */
    body {
        background-color: #f8f9fa; 
    }
    
    .dashboard { 
        padding: 20px; 
        min-height: 100vh; 
    }
    
    .dashboard h1 { 
        font-size: 24px; 
        font-weight: bold; 
        color: #0A0A0A; 
        margin-bottom: 5px; 
    }
    
    .subtitle { 
        color: #717182; 
        font-size: 16px; 
        margin-bottom: 20px; 
    }
    
    .card { 
        background: white; 
        border-radius: 12px; 
        padding: 20px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        margin-bottom: 20px; 
    }
    
    .metric-label { 
        color: #717182; 
        font-size: 14px; 
        margin-bottom: 5px; 
    }
    
    .graph-container { 
        position: relative; 
        height: 350px; 
        width: 100%; 
        margin: 20px 0; 
    }
    
    .graph-axes { 
        position: absolute; 
        top: 0; 
        left: 50px; 
        right: 20px; 
        bottom: 50px; 
        border-left: 1px solid #e5e7eb; 
        border-bottom: 1px solid #e5e7eb; 
    }
    
    .y-axis { 
        position: absolute; 
        left: -50px; 
        top: 0; 
        bottom: 0; 
        width: 40px; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-between; 
    }
    
    .y-label { 
        color: #717182; 
        font-size: 12px; 
        text-align: right; 
        padding-right: 10px; 
    }
    
    .x-axis { 
        position: absolute; 
        left: 0; 
        right: 0; 
        bottom: -40px; 
        height: 40px; 
        display: flex; 
        justify-content: space-between; 
    }
    
    .x-label { 
        color: #717182; 
        font-size: 12px; 
        text-align: center; 
        width: 40px; 
        transform: rotate(-45deg); 
        transform-origin: top left; 
    }
    
    .graph-line { 
        position: absolute; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        height: 100%; 
        display: flex; 
        align-items: flex-end; 
    }
    
    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 20px; 
        margin-top: 30px; 
    }
    
    .stat-card { 
        background: white; 
        border-radius: 12px; 
        padding: 24px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        height: 100%; 
    }
    
    .stat-title { 
        color: #717182; 
        font-size: 14px; 
        margin-bottom: 8px; 
    }
    
    .stat-number { 
        font-size: 32px; 
        font-weight: bold; 
        color: #0A0A0A; 
    }
    
    .stat-cost { 
        color: #00A63D; 
    }
    
    .stat-unit { 
        font-size: 16px; 
        color: #717182; 
        margin-left: 4px; 
    }
</style>

@{
    var totalUsage = Model.ElectricityLast4Hours.Sum((HourlyValueDto a) => a.Value);
    var peakUsage = Model.ElectricityLast4Hours.Any() 
        ? Model.ElectricityLast4Hours.Max((HourlyValueDto a) => a.Value) 
        : 0;
    var peakHour = Model.ElectricityLast4Hours.Any() 
        ? Model.ElectricityLast4Hours.First(a => a.Value == peakUsage).Hour 
        : 0;
    var estimatedCost = totalUsage * 0.128; // Example cost per kWh
}

<div class="dashboard">
    <div class="page-header">
        <div>
            <h1>Electricity Graph</h1>
            <p class="subtitle">Power consumption over the last 4 hours</p>
        </div>
    </div>

    <div class="card">
        <h2>4-Hour Electricity Usage</h2>
        <p class="metric-label">Hourly usage in kWh</p>
        <div class="graph-container">
            <div class="graph-axes">
                <div class="y-axis">
                    <div class="y-label">4 kWh</div>
                    <div class="y-label">3 kWh</div>
                    <div class="y-label">2 kWh</div>
                    <div class="y-label">1 kWh</div>
                    <div class="y-label">0 kWh</div>
                </div>

                <div class="x-axis">
                    @foreach (var item in Model.ElectricityLast4Hours)
                    {
                        <div class="x-label">@item.Hour:00</div>
                    }
                </div>

                <div class="graph-line" id="electricityGraph"></div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-title">Total Usage</div>
            <div class="stat-number">@totalUsage?.ToString("0.00") <span class="stat-unit">kWh</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Peak at @peakHour:00</div>
            <div class="stat-number">@peakUsage?.ToString("0.00") <span class="stat-unit">kWh</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Estimated Cost</div>
            <div class="stat-number stat-cost">$@estimatedCost?.ToString("0.00")</div>
        </div>
    </div>
</div>

<script>
    const electricityData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.ElectricityLast4Hours,
        new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }
    ));

    const graphElement = document.getElementById('electricityGraph');

    electricityData.forEach((item, index) => {
        const pointContainer = document.createElement('div');
        pointContainer.className = 'data-point';

        const point = document.createElement('div');
        point.className = 'point-value';

        const MAX_KWH = 4;
        const heightPercent = Math.min((item.value / MAX_KWH) * 100, 100);
        point.style.height = `${heightPercent}%`;
        point.style.setProperty('--point-height', `${heightPercent}%`);

        point.title = `${item.hour.toString().padStart(2,'0')}:00 – ${item.value.toFixed(2)} kWh`;

        pointContainer.appendChild(point);

        if (index % 3 === 0) {
            const label = document.createElement('div');
            label.className = 'point-label';
            label.textContent = `${item.hour.toString().padStart(2,'0')}:00`;
            pointContainer.appendChild(label);
        }

        graphElement.appendChild(pointContainer);
    });
</script>